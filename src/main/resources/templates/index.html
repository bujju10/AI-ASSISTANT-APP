<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Smart Travel Assistant</title>
    <link rel="stylesheet" th:href="@{/css/styles.css}">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        #map {
            height: 400px;
            width: 100%;
            border-radius: 10px;
        }
    </style>
</head>
<body>
<header>
    <!doctype html>
    <html lang="en">
        <head>
            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width,initial-scale=1">
            <title>Smart Travel Assistant — Futurist UI</title>
            <link rel="stylesheet" th:href="@{/css/styles.css}">
            <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
            <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
        </head>
        <body class="futuristic">
            <nav class="topbar">
                <div class="brand">Smart Travel Assistant</div>
                <div class="actions">
                    <span id="topUser" style="color:var(--muted);margin-right:8px"></span>
                    <button onclick="location.href='/register.html'">Register</button>
                    <button onclick="location.href='/login.html'">Login</button>
                    <button onclick="location.href='/routes.html'">Routes</button>
                    <button onclick="location.href='/bookcab.html'">Book Cab</button>
                    <button onclick="location.href='/history.html'">History</button>
                    <button id="orsStatusBtn" class="btn-ghost">ORS: <span id="orsStatus">unknown</span></button>
                    <button id="logoutBtn" class="btn-ghost">Logout</button>
                </div>
            </nav>

            <main class="grid">
                <section class="panel search">
                    <h3>Plan a Trip</h3>
                    <div class="inputs">
                        <input id="homeStart" placeholder="Start (city or place)" />
                        <input id="homeEnd" placeholder="Destination" />
                        <select id="homeMode"><option>Driving</option><option>Walking</option><option>Public Transport</option></select>
                        <button id="homePlan">Analyze & Ask LLM</button>
                    </div>
                    <div id="homeSuggestion" class="suggestion"></div>
                    <div id="homeSuggestionActions" style="margin-top:8px"></div>
                </section>

                <section class="panel map">
                    <div id="map" style="height:100%; border-radius:12px;"></div>
                </section>

                <section class="panel chat">
                    <h3>Chat with Travel LLM</h3>
                    <div id="chatHistoryBox" class="chatHistory"></div>
                    <input id="chatInputHome" placeholder="Ask travel assistant..." />
                    <button id="chatSendHome">Send</button>
                </section>
            </main>

            <footer class="footer">© Smart Travel Assistant</footer>

            <script src="/js/ui.js"></script>
                        <script type="module">
                            import { planAndDraw } from '/js/routes_client.js';
                            import { askWithFreeSearch } from '/js/search_free_client.js';
                            window.planAndDraw = planAndDraw;
                            window.askWithFreeSearch = askWithFreeSearch;
                        </script>
                        <script src="/js/llm_chat.js"></script>
                        <script src="/js/llm_utils.js"></script>
                        <!-- ORS key modal -->
                        <div id="orsModal" class="modal" style="display:none;position:fixed;inset:0;align-items:center;justify-content:center;">
                            <div style="background:var(--bg);padding:16px;border-radius:8px;min-width:320px;box-shadow:0 8px 30px rgba(0,0,0,0.6)">
                                <h4>OpenRouteService API Key</h4>
                                <p style="font-size:0.9em;color:var(--muted)">Paste your ORS API key to enable geocoding & routing from the browser.</p>
                                <input id="orsKeyInput" style="width:100%;padding:8px;margin:8px 0" placeholder="Enter ORS API key" />
                                <div style="text-align:right">
                                    <button id="orsSave">Save</button>
                                    <button id="orsCancel" class="btn-ghost">Cancel</button>
                                </div>
                            </div>
                        </div>
            <script>
                // Initialize map minimal
                const map = L.map('map').setView([9.4981, 76.3388], 10);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'© OpenStreetMap contributors'}).addTo(map);

                                // ORS key UI wiring
                                function updateOrsStatus(){
                                    const k = localStorage.getItem('orsKey');
                                    const el = document.getElementById('orsStatus');
                                    el.textContent = k? 'set' : 'not set';
                                }
                                document.getElementById('orsStatusBtn').addEventListener('click', ()=>{
                                    document.getElementById('orsModal').style.display='flex';
                                    document.getElementById('orsKeyInput').value = localStorage.getItem('orsKey')||'';
                                });
                                document.getElementById('orsCancel').addEventListener('click', ()=> document.getElementById('orsModal').style.display='none');
                                document.getElementById('orsSave').addEventListener('click', ()=>{
                                    const v = document.getElementById('orsKeyInput').value.trim();
                                    if (!v) { uiToast('Please enter a key','error'); return; }
                                    localStorage.setItem('orsKey', v);
                                    updateOrsStatus();
                                    document.getElementById('orsModal').style.display='none';
                                    uiToast('ORS key saved','success');
                                });
                                updateOrsStatus();

                // Basic home interactions: draw route using planAndDraw
                                // Keep last plan inputs so user can retry easily
                                let _lastPlan = null;
                                function setRetryButton(visible){
                                    const container = document.getElementById('homeSuggestionActions');
                                    container.innerHTML = '';
                                    if (!visible) return;
                                    const btn = document.createElement('button'); btn.textContent='Retry'; btn.style.marginRight='8px';
                                    btn.addEventListener('click', ()=>{ if (_lastPlan) document.getElementById('homePlan').click(); });
                                    container.appendChild(btn);
                                }

                                document.getElementById('homePlan').addEventListener('click', async () => {
                                        const start = document.getElementById('homeStart').value.trim();
                                        const end = document.getElementById('homeEnd').value.trim();
                                        if (!start || !end) return uiToast('Enter start and destination','error');
                                        const apiKey = localStorage.getItem('orsKey') || '';
                                        _lastPlan = {start,end,apiKey};
                                        setRetryButton(false);
                                        try {
                                                document.getElementById('homeSuggestion').textContent = 'Planning and drawing route...';
                                                const {coords, route} = await window.planAndDraw(map, start, end, apiKey);
                                                document.getElementById('homeSuggestion').textContent = 'Route drawn — preparing route summary for LLM...';
                                                // Build structured route summary (distance, duration, top steps) to send to LLM
                                                let distanceKm = 'N/A';
                                                let durationMin = 'N/A';
                                                let stepsList = [];
                                                try {
                                                    const feat = route && route.features && route.features[0];
                                                    const props = feat && feat.properties;
                                                    if (props && props.summary) {
                                                        if (props.summary.distance != null) distanceKm = (props.summary.distance/1000).toFixed(2);
                                                        if (props.summary.duration != null) durationMin = Math.round(props.summary.duration/60);
                                                    }
                                                    const segs = props && props.segments;
                                                    if (segs && segs.length && segs[0].steps) {
                                                        stepsList = segs[0].steps.map(s => ({
                                                            instruction: s.instruction || s.name || s.type || '',
                                                            distance: s.distance, duration: s.duration
                                                        }));
                                                    }
                                                } catch (err) {
                                                    console.warn('Unable to extract route summary', err);
                                                }

                                                const topN = Math.min(6, stepsList.length);
                                                const stepsText = stepsList.slice(0, topN).map((s,i)=> {
                                                    const d = s.distance!=null? Math.round(s.distance)+'m':'?m';
                                                    const t = s.duration!=null? Math.round((s.duration/60))+'min':'?min';
                                                    return `${i+1}. ${s.instruction} (${d}, ${t})`;
                                                }).join('\n');

                                                const prompt = `You are an expert travel assistant. Analyze the following planned route and provide a concise recommendation (1-2 sentences), 3 short reasons, and if applicable, suggest better alternative modes (brief justification).\n\nOrigin: ${start}\nDestination: ${end}\nDistance: ${distanceKm} km\nEstimated duration: ${durationMin} minutes\nTop steps:\n${stepsText}\n\nBe concise and focus on traveler concerns: fastest vs shortest, traffic-sensitive segments, safety, public transit convenience, and any obvious transfer/walking pain points.`;

                                                                        document.getElementById('homeSuggestion').textContent = 'Getting LLM suggestion (enriched with free web context)...';
                                                                        setRetryButton(false);
                                                                        let suggestion;
                                                                        try{
                                                                            // prefer server-side free search augmentation which uses Nominatim + Wikidata
                                                                            const res = await window.askWithFreeSearch(prompt, start, end);
                                                                            // res is the raw LLM proxy response (choices) returned by getRouteSuggestion
                                                                            if (res && res.choices && res.choices[0] && res.choices[0].message) {
                                                                                suggestion = res.choices[0].message.content;
                                                                            } else if (res && res.error) {
                                                                                throw new Error(res.error);
                                                                            } else {
                                                                                // fallback to plain LLM call
                                                                                suggestion = await getLLMSuggestion(prompt);
                                                                            }
                                                                        } catch (err){
                                                                            uiToast('LLM error: '+err.message,'error');
                                                                            document.getElementById('homeSuggestion').textContent = 'LLM error: '+err.message;
                                                                            setRetryButton(true);
                                                                            return;
                                                                        }

                                                // Render suggestion; try to parse structured JSON block if present
                                                const container = document.getElementById('homeSuggestion');
                                                container.innerHTML = '';
                                                const parsed = window.parseStructuredJSONFromText ? window.parseStructuredJSONFromText(suggestion) : null;
                                                if (parsed && typeof parsed === 'object'){
                                                    // render structured fields if present
                                                    const h = document.createElement('div'); h.className='llm-structured';
                                                    if (parsed.recommended_mode) h.innerHTML += `<div><strong>Recommended mode:</strong> ${parsed.recommended_mode}</div>`;
                                                    if (parsed.estimated_time_minutes) h.innerHTML += `<div><strong>Estimated time:</strong> ${parsed.estimated_time_minutes} minutes</div>`;
                                                    if (parsed.estimated_cost) h.innerHTML += `<div><strong>Estimated cost:</strong> ${parsed.estimated_cost}</div>`;
                                                    if (parsed.explanation) h.innerHTML += `<div style="margin-top:8px">${parsed.explanation}</div>`;
                                                    container.appendChild(h);
                                                }
                                                // Always append the raw suggestion text for fallback
                                                const p = document.createElement('pre'); p.style.whiteSpace='pre-wrap'; p.textContent = suggestion; container.appendChild(p);
                                                if (stepsText) {
                                                    const pre = document.createElement('pre'); pre.style.marginTop='8px'; pre.style.whiteSpace='pre-wrap'; pre.textContent = stepsText; container.appendChild(pre);
                                                }
                                                setRetryButton(false);
                                        } catch (e) {
                                                uiToast('Route planning failed: '+(e.message||e),'error');
                                                document.getElementById('homeSuggestion').textContent = 'Failed to plan route.';
                                                setRetryButton(true);
                                        }
                                });

                // Chat
                document.getElementById('chatSendHome').addEventListener('click', async () => {
                    const prompt = document.getElementById('chatInputHome').value.trim();
                    if (!prompt) return uiToast('Enter a message','error');
                    const hist = document.getElementById('chatHistoryBox');
                    hist.innerHTML += `<div class="userMsg">You: ${prompt}</div>`;
                    const reply = await chatWithLLM(prompt).catch(e=> 'LLM error');
                    hist.innerHTML += `<div class="botMsg">LLM: ${reply}</div>`;
                    hist.scrollTop = hist.scrollHeight;
                });

                // show logged in user in topbar
                const uid = localStorage.getItem('userId');
                if (uid) {
                  fetch(`/api/users/${uid}`).then(r=> r.ok? r.json(): null).then(u=>{
                    if (u && u.name) document.getElementById('topUser').textContent = 'Hi, '+u.name;
                  }).catch(()=>{});
                }
                document.getElementById('logoutBtn').addEventListener('click', ()=>{ localStorage.removeItem('userId'); uiToast('Logged out','info'); setTimeout(()=>location.reload(),600); });
            </script>
        </body>
    </html>
</body>
